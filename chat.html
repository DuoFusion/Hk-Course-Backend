<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
</head>
<body>
  <h2>Real-time Chat</h2>

  <label>Sender ID: <input id="senderId" placeholder="Sender ObjectId" /></label><br />
  <label>Receiver ID: <input id="receiverId" placeholder="Receiver ObjectId" /></label><br />
  <label>Message: <input id="message" placeholder="Type message" /></label><br />
  <button onclick="sendMessage()">Send Message</button>
  <button onclick="markAsSeen()">Mark as Seen</button>

  <h3>Unread Count: <span id="unreadCount">0</span></h3>

  <h3>Chat History</h3>
  <ul id="chatBox"></ul>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io('http://localhost:2222');

    const senderInput = document.getElementById('senderId');
    const receiverInput = document.getElementById('receiverId');
    const messageInput = document.getElementById('message');
    const chatBox = document.getElementById('chatBox');
    const unreadCountSpan = document.getElementById('unreadCount');

    senderInput.addEventListener('blur', () => {
      const userId = senderInput.value;
      if (userId) {
        socket.emit('join', userId);
        socket.emit('get_unread_count', { receiverId: userId });
        loadChats();
      }
    });

    receiverInput.addEventListener('blur', loadChats);

    function sendMessage() {
      const senderId = senderInput.value.trim();
      const receiverId = receiverInput.value.trim();
      const message = messageInput.value.trim();
      if (!senderId || !receiverId || !message) return alert('All fields are required');
      socket.emit('send_message', { senderId, receiverId, message });
      messageInput.value = '';
    }

    function markAsSeen() {
      const senderId = receiverInput.value.trim();
      const receiverId = senderInput.value.trim();
      if (!senderId || !receiverId) return;
      socket.emit('mark_seen', { senderId, receiverId });
    }

    function loadChats() {
      const senderId = senderInput.value.trim();
      const receiverId = receiverInput.value.trim();
      if (!senderId || !receiverId) return;
      socket.emit('get_all_chats', { senderId, receiverId });
    }

    socket.on('receive_message', (msg) => {
      const li = document.createElement('li');
      li.textContent = `[${msg.senderId}] ➡ [${msg.receiverId}]: ${msg.message}`;
      chatBox.appendChild(li);
    });

    socket.on('get_all_chats_response', (chats) => {
      chatBox.innerHTML = '';
      chats.forEach((msg) => {
        const li = document.createElement('li');
        li.textContent = `[${msg.senderId}] ➡ [${msg.receiverId}]: ${msg.message}`;
        chatBox.appendChild(li);
      });
    });

    socket.on('unread_count', ({ count }) => {
      unreadCountSpan.textContent = count;
    });

    socket.on('messages_seen', ({ receiverId }) => {
      console.log(`Messages seen by ${receiverId}`);
    });
  </script>
</body>
</html>
